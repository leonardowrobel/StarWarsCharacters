<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="./css/bootstrap.css" />
    <link rel="stylesheet" href="./css/other.css" />
</head>

<body class="container">
    <div class="d-flex mt-5 row">
        <div class="col-12 justify-content-center d-flex">
            <img src="src/star-wars-logo.png" class="logo" />
        </div>
        <div class="col-12 justify-content-center d-flex">
            <p><span><small>Characters</small></span></p>
        </div>
    </div>

    <div class="d-flex justify-content-center mt-5 row" id="main">
        <div class="spinner-border m-5 b-5" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <div class="d-none mb-5" id="controls">
        <button type="button" class="btn btn-primary btn-lg m-1" id="btnprev">
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-left" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                    d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
            </svg></button>
        <button type="button" class="btn btn-primary btn-lg m-1" id="btnnext">
            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-arrow-right" fill="currentColor"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                    d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8z" />
            </svg>
        </button>
    </div>
    <script src="js/jquery-3.5.1.min.js"></script>
    <script src="js/bootstrap.js"></script>

    <script>
        $(document).ready(function () {
            getCharacters("https://swapi.dev/api/people/");
        });

        function getCharacters(link) {
            $.getJSON(link)
                .done(function (data) {
                    $("#main").empty();
                    $("#main").append("<div class=\"accordion col-10\" id=\"characteres\">");

                    //$("#main").append("<ul id=\"characteres\"></ul>");
                    //$("#characteres").append(data);
                    $.each(data.results, function (i, item) {
                        //let id = item.name.replace(" ", "-").toLowerCase();
                        let id = "ch" + item.url.substr(item.url.length - 3).replace(/\D/g, "");
                        let tag = "<div class=\"card\" id=\"" + "card" + id + "\"><div class=\"card-header\"";
                        tag += "<h2 class=\"mb-0\"><button class=\"btn btn-block text-left\" type=\"button\" data-toggle=\"collapse\" data-target=\"#" + id + "\">" + item.name;
                        tag += "</button></h2></div>";

                        tag += "<div id=\"" + id + "\" class=\"collapse\" data-parent=\"#characteres\"><div class=\"card-body\">";

                        tag += "<div class=\"row \">";
                        tag += "<div class=\"col-md-7 col-8 perfil d-flex justify-content-end\"> <div class=\"spinner-border m-md-5\" role=\"status\"><span class=\"sr-only\">Loading...</span></div> </div>";
                        tag += "<div class=\"col-md-5 col-4 status\"><p><span class='atribute'>Height:</span> " + item.height + (item.height == 'unknown' ? "" : " cm") + "</p>";
                        tag += "<p><span class='atribute'> Mass:</span> " + item.mass + (item.mass == 'unknown' ? "" : " Kg") + "</p>";
                        tag += "<p><span class='atribute'>Hair:</span> " + item.hair_color + "</p>";
                        tag += "<p><span class='atribute'>Skin color:</span> " + item.skin_color + "</p>";
                        tag += "<p><span class='atribute'>Eye color:</span> " + item.eye_color + "</p>";
                        tag += "<p><span class='atribute'>Birth year:</span> " + item.birth_year + "</p>";
                        tag += "<p><span class='atribute'>Gender: </span>" + item.gender + "</p></div>";

                        tag += "</div></div></div></div>";

                        $("#characteres").append(tag);


                    });

                    $("#main").append("</div>");

                    $("#controls").removeClass("d-none").addClass("d-flex justify-content-center mt-1");

                    if (data.previous == null) {
                        $("#btnprev").attr("disabled", true).removeClass("btn-primary").addClass("btn-secondary");
                    } else {
                        $("#btnprev").attr("disabled", false).addClass("btn-primary").removeClass("btn-secondary");
                        $("#btnprev").click(function () {
                            $("#btnprev").prop("onclick", null).off("click");
                            $("#btnnext").prop("onclick", null).off("click");
                            getCharacters(data.previous);                            
                        });
                    }

                    if (data.next == null) {
                        $("#btnnext").attr("disabled", true).removeClass("btn-primary").addClass("btn-secondary");
                    } else {
                        $("#btnnext").attr("disabled", false).addClass("btn-primary").removeClass("btn-secondary");
                        $("#btnnext").click(function () {
                            $("#btnnext").prop("onclick", null).off("click");
                            $("#btnprev").prop("onclick", null).off("click");
                            getCharacters(data.next);                            
                        });
                    }

                    $('.collapse').on('show.bs.collapse', function (d) {
                        let chid = d.currentTarget.id.substr(2);
                        $("#card" + chid).css("");
                        let imgurl = "https://starwars-visualguide.com/assets/img/characters/" + chid + ".jpg"
                        $(this).find('.perfil').empty().append('<img class="profile" height="300" src="' + imgurl + '" />');
                    })
                })
                .fail(function (jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                    console.log("Request Failed: " + err);
                });
        }
    </script>
    </div>
</body>

</html>